
---
title: "Dashboard Spotify 2024"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(shiny)
library(readr)
library(lubridate)
library(here)
```

## Controles {data-width=250}

```{r}
# Filtro de artista
selectizeInput("artist_filter", "Selecciona artista:",
               choices = NULL, multiple = TRUE, options = list(maxOptions = 500))

# Filtro de álbum
selectizeInput("album_filter", "Selecciona álbum:",
               choices = NULL, multiple = TRUE, options = list(maxOptions = 500))

# Filtro de rango de fechas
dateRangeInput("date_filter", "Selecciona rango de fechas:",
               start = Sys.Date() - 180, end = Sys.Date())
```

## Carga de datos

```{r}
# ---- Cargar y depurar los datos ----
# Corrección: Usamos here() para que el archivo sea encontrado sin importar
# la carpeta de trabajo del proyecto
spotify <- read_csv(here("Spotify2024_clean.csv"))

# Depuramos los datos para asegurar los tipos de dato correctos
spotify <- spotify %>%
  mutate(
    fecha_lanz = ymd(fecha_lanz),
    spotify_pop = as.numeric(spotify_pop),
    spotify_streams = as.numeric(spotify_streams)
  ) %>%
  filter(!is.na(spotify_pop) & !is.na(spotify_streams))
```

## Tabla de Datos

```{r}
renderDT({
  # Filtramos los datos de la misma manera que en el gráfico
  spotify %>%
    filter(
      (is.null(input$artist_filter) | artista %in% input$artist_filter),
      (is.null(input$album_filter) | album %in% input$album_filter),
      fecha_lanz >= input$date_filter[1] & fecha_lanz <= input$date_filter[2]
    ) %>%
    # Usamos datatable para crear una tabla interactiva y con opciones de búsqueda
    datatable(options = list(pageLength = 10))
})
```

## Gráficos

### Evolución de Streams

```{r}
renderPlotly({
  # Filtramos los datos basados en la selección del usuario
  data_filtered <- spotify %>%
    filter(
      (is.null(input$artist_filter) | artista %in% input$artist_filter),
      (is.null(input$album_filter) | album %in% input$album_filter),
      fecha_lanz >= input$date_filter[1] & fecha_lanz <= input$date_filter[2]
    )
  
  # Creamos el gráfico de líneas
  p <- ggplot(data_filtered, aes(x = fecha_lanz, y = spotify_streams, color = album, group = artista)) +
    geom_line() +
    theme_minimal() +
    labs(title = "Evolución de Streams por Artista", x = "Fecha de lanzamiento", y = "Streams")
  
  ggplotly(p)
})
```

### Popularidad vs Streams

```{r}
renderPlotly({
  # Filtramos los datos basados en la selección del usuario
  data_filtered <- spotify %>%
    filter(
      (is.null(input$artist_filter) | artista %in% input$artist_filter),
      (is.null(input$album_filter) | album %in% input$album_filter),
      fecha_lanz >= input$date_filter[1] & fecha_lanz <= input$date_filter[2]
    )

  # Creamos el gráfico de dispersión con plotly
  p <- ggplot(data_filtered, aes(x = spotify_streams, y = spotify_pop, color = artista,
                                 text = paste("Artista:", artista,
                                              "<br>Canción:", cancion,
                                              "<br>Streams:", spotify_streams,
                                              "<br>Popularidad:", spotify_pop))) +
    geom_point(alpha = 0.6) +
    theme_minimal() +
    labs(
      title = "Correlación entre Streams y Popularidad",
      x = "Reproducciones en Spotify",
      y = "Popularidad en Spotify"
    )

  ggplotly(p, tooltip = "text")
})
```
